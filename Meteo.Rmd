---
title: 'Análisis calidad del aire Madrid'
author: "Autor: Sergio Romero Córdoba"
date: "Marzo 2022"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Estudio de la calidad del aire en Madrid

```{r message= FALSE, warning=FALSE}

library(dplyr)
library(tidyr)
library(tidyverse)
library(lubridate)
library(ggplot2)

```

## Análisis y acondicionado de juego de datos de calidad del aire

### Carga y limpieza del juego de datos diraios de calidad del aire

Cargamos en primer lugar el conjunto de datos meteorológicos diariosvemos su estructura.

```{r message= FALSE, warning=FALSE}

mydir = "Datos meteo diarios"
myFiles = list.files(path = mydir, pattern = "*.csv", full.names = TRUE)
datos_diarios_meteo <- lapply(myFiles, read_csv2) %>% bind_rows()
str(datos_diarios_meteo)

```

Cada registro está estructurado de la siguiente forma:

PROVINCIA, MUNICIPIO, ESTACION, MAGNITUD, PUNTO_MUESTREO, ANO, MES, D01, V01, D02, V02...

Donde D01 corresponde al dato del primer día del mes, D02 al del segundo día y así sucesivamente.

Vamos a ver ahora los distintos valores para la columna MAGNITUD. Estos valores nos identifican los distintos datos que se miden en cada una de las estaciones:

```{r message= FALSE, warning=FALSE}

distinct(datos_diarios_meteo, MAGNITUD)

```

En la definición del conjunto de datos encontramos los datos que corresponden a cada uno de estos códigos:

```{r table3, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

cat("
| ID    | Descripción                |
|-------|:---------------------------|
| 80    | RADIACIÓN ULTRAVIOLETA     |
| 81    | VELOCIDAD VIENTO           |
| 82    | DIR. DE VIENTO             |
| 83    | TEMPERATURA                | 
| 86    | HUMEDAD RELATIVA           |
| 87    | PRESION BARIOMETRICA       |
| 88    | RADIACION SOLAR            |
| 89    | PRECIPITACIÓN              |
")

```

Las columnas Vx identifican los valores que han sido validados. Vamos a limpiar en primer lugar los datos no validados.

```{r message= FALSE, warning=FALSE}

datos_diarios_meteo$D01 <- ifelse(datos_diarios_meteo$V01 == "N", NA, datos_diarios_meteo$D01)
datos_diarios_meteo$D02 <- ifelse(datos_diarios_meteo$V02 == "N", NA, datos_diarios_meteo$D02)
datos_diarios_meteo$D03 <- ifelse(datos_diarios_meteo$V03 == "N", NA, datos_diarios_meteo$D03)
datos_diarios_meteo$D04 <- ifelse(datos_diarios_meteo$V04 == "N", NA, datos_diarios_meteo$D04)
datos_diarios_meteo$D05 <- ifelse(datos_diarios_meteo$V05 == "N", NA, datos_diarios_meteo$D05)
datos_diarios_meteo$D06 <- ifelse(datos_diarios_meteo$V06 == "N", NA, datos_diarios_meteo$D06)
datos_diarios_meteo$D07 <- ifelse(datos_diarios_meteo$V07 == "N", NA, datos_diarios_meteo$D07)
datos_diarios_meteo$D08 <- ifelse(datos_diarios_meteo$V08 == "N", NA, datos_diarios_meteo$D08)
datos_diarios_meteo$D09 <- ifelse(datos_diarios_meteo$V09 == "N", NA, datos_diarios_meteo$D09)
datos_diarios_meteo$D10 <- ifelse(datos_diarios_meteo$V10 == "N", NA, datos_diarios_meteo$D10)
datos_diarios_meteo$D11 <- ifelse(datos_diarios_meteo$V11 == "N", NA, datos_diarios_meteo$D11)
datos_diarios_meteo$D12 <- ifelse(datos_diarios_meteo$V12 == "N", NA, datos_diarios_meteo$D12)
datos_diarios_meteo$D13 <- ifelse(datos_diarios_meteo$V13 == "N", NA, datos_diarios_meteo$D13)
datos_diarios_meteo$D14 <- ifelse(datos_diarios_meteo$V14 == "N", NA, datos_diarios_meteo$D14)
datos_diarios_meteo$D15 <- ifelse(datos_diarios_meteo$V15 == "N", NA, datos_diarios_meteo$D15)
datos_diarios_meteo$D16 <- ifelse(datos_diarios_meteo$V16 == "N", NA, datos_diarios_meteo$D16)
datos_diarios_meteo$D17 <- ifelse(datos_diarios_meteo$V17 == "N", NA, datos_diarios_meteo$D17)
datos_diarios_meteo$D18 <- ifelse(datos_diarios_meteo$V18 == "N", NA, datos_diarios_meteo$D18)
datos_diarios_meteo$D19 <- ifelse(datos_diarios_meteo$V19 == "N", NA, datos_diarios_meteo$D19)
datos_diarios_meteo$D20 <- ifelse(datos_diarios_meteo$V20 == "N", NA, datos_diarios_meteo$D20)
datos_diarios_meteo$D21 <- ifelse(datos_diarios_meteo$V21 == "N", NA, datos_diarios_meteo$D21)
datos_diarios_meteo$D22 <- ifelse(datos_diarios_meteo$V22 == "N", NA, datos_diarios_meteo$D22)
datos_diarios_meteo$D23 <- ifelse(datos_diarios_meteo$V23 == "N", NA, datos_diarios_meteo$D23)
datos_diarios_meteo$D24 <- ifelse(datos_diarios_meteo$V24 == "N", NA, datos_diarios_meteo$D24)
datos_diarios_meteo$D25 <- ifelse(datos_diarios_meteo$V25 == "N", NA, datos_diarios_meteo$D25)
datos_diarios_meteo$D26 <- ifelse(datos_diarios_meteo$V26 == "N", NA, datos_diarios_meteo$D26)
datos_diarios_meteo$D27 <- ifelse(datos_diarios_meteo$V27 == "N", NA, datos_diarios_meteo$D27)
datos_diarios_meteo$D28 <- ifelse(datos_diarios_meteo$V28 == "N", NA, datos_diarios_meteo$D28)
datos_diarios_meteo$D29 <- ifelse(datos_diarios_meteo$V29 == "N", NA, datos_diarios_meteo$D29)
datos_diarios_meteo$D30 <- ifelse(datos_diarios_meteo$V30 == "N", NA, datos_diarios_meteo$D30)
datos_diarios_meteo$D31 <- ifelse(datos_diarios_meteo$V31 == "N", NA, datos_diarios_meteo$D31)


```


Vamos a eliminar algunas de las columnas que no nos aportan información:

- Las columnas Vx

- Las columnas PROVINCIA, MUNICIPIO y PUNTO_MUESTREO no aportan información ya que se trata para todos los casos de estaciones de Madrid y el punto de muestreo es una combinación de los valores de provincia, municipio y estación.

```{r message= FALSE, warning=FALSE}

datos_diarios_meteo <- datos_diarios_meteo[, -grep("^V", colnames(datos_diarios_meteo))]
datos_diarios_meteo <- subset(datos_diarios_meteo, select = -c(PROVINCIA, MUNICIPIO, PUNTO_MUESTREO))

```

A continuación, reorganizamos nuestro dataframe de manera que las distintas magnitudes se muestren como columnas, mientras que los días pasaran a ser filas (cada fila corresponderá a un día).

```{r message= FALSE, warning=FALSE}

datos_diarios_meteo <- datos_diarios_meteo %>%
  gather("DIA", "VALOR", D01:D31) %>%
  spread(key = MAGNITUD, value = "VALOR")

```

Por último, cambiamos el nombre de las columnas para poner un nombre significativo, convertimos las columnas con los valores de los contaminantes a tipo numeric y factorizamos las columnas de año y estación.

```{r message= FALSE, warning=FALSE}

colnames(datos_diarios_meteo) <- c("ESTACION", "ANO", "MES", "DIA", "VEL_VIENTO", "DIR_VIENTO", "TEMPERATURA", "HUMEDAD", "PRESION", "RADIACION", "PRECIPITACION")

datos_diarios_meteo$VEL_VIENTO <- as.numeric(datos_diarios_meteo$VEL_VIENTO)
datos_diarios_meteo$DIR_VIENTO <- as.numeric(datos_diarios_meteo$DIR_VIENTO)
datos_diarios_meteo$TEMPERATURA <- as.numeric(datos_diarios_meteo$TEMPERATURA)
datos_diarios_meteo$HUMEDAD <- as.numeric(datos_diarios_meteo$HUMEDAD)
datos_diarios_meteo$PRESION <- as.numeric(datos_diarios_meteo$PRESION)
datos_diarios_meteo$RADIACION <- as.numeric(datos_diarios_meteo$RADIACION)
datos_diarios_meteo$PRECIPITACION <- as.numeric(datos_diarios_meteo$PRECIPITACION)

datos_diarios_meteo$ANO <- as.factor(datos_diarios_meteo$ANO)
datos_diarios_meteo$ESTACION <- as.factor(datos_diarios_meteo$ESTACION)

summary(datos_diarios_meteo)

```


### Carga de juego de datos con información de estaciones

Cargamos el conjunto de datos con informaciones de las estaciones de control y vemos su estructura.

```{r message= FALSE, warning=FALSE}

datos_estaciones_meteo <- read_csv2("Estaciones meteo/Estaciones_control_datos_meteorologicos.csv", locale(encoding = "ISO-8859-1"), col_names = TRUE, col_types = NULL)
str(datos_estaciones_meteo)

```

Vamos a obviar la información geográfica para el análisis en R y vamos a quedarnos únicamente con el nombre.

```{r message= FALSE, warning=FALSE}

datos_estaciones_meteo <- datos_estaciones_meteo[,c("CÓDIGO_CORTO", "ESTACIÓN")]

```

Añadimos esta información al conjunto de datos diarios de calidad del aire.

```{r message= FALSE, warning=FALSE}

datos_diarios_meteo <- merge(x = datos_diarios_meteo, y = datos_estaciones_meteo, by.x = "ESTACION", by.y = "CÓDIGO_CORTO", all = TRUE)
colnames(datos_diarios_meteo)[12] <- "NOM_ESTACION"

```

### Análisis de datos meteorológicos

Outliers

```{r message= FALSE, warning=FALSE}

ggplot(datos_diarios_meteo, aes(y = VEL_VIENTO)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  VEL_VIENTO") +
  theme_bw() +
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_diarios_meteo, aes(y = DIR_VIENTO)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  DIR_VIENTO") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_diarios_meteo, aes(y = TEMPERATURA)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  TEMPERATURA") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_diarios_meteo, aes(y = HUMEDAD)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  HUMEDAD") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_diarios_meteo, aes(y = PRESION)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  PRESION") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_diarios_meteo, aes(y = RADIACION)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  RADIACION") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_diarios_meteo, aes(y = PRECIPITACION)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  PRECIPITACION") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

```








```{r message= FALSE, warning=FALSE}

write_csv(datos_diarios_aire, path = "datos_diarios_aire.csv", append = FALSE, col_names = TRUE, na = '')

```












```{r message= FALSE, warning=FALSE}

mydir = "Datos meteo horarios"
myFiles = list.files(path = mydir, pattern = "*.csv", full.names = TRUE, recursive = TRUE)
datos_horarios_meteo <- myFiles %>% map_df(~read_csv2(.x) %>% mutate(MES = as.character(MES)))

```

```{r message= FALSE, warning=FALSE}

datos_horarios_meteo <- datos_horarios_meteo[, -grep("^V", colnames(datos_horarios_meteo))]
datos_horarios_meteo <- subset(datos_horarios_meteo, select = -c(PROVINCIA, MUNICIPIO, PUNTO_MUESTREO))

datos_horarios_meteo <- datos_horarios_meteo %>%
  gather("HORA", "VALOR", H01:H24) %>%
  spread(key = MAGNITUD, value = "VALOR")

```

```{r message= FALSE, warning=FALSE}

colnames(datos_horarios_meteo) <- c("ESTACION", "ANO", "MES", "DIA", "HORA", "VEL_VIENTO", "DIR_VIENTO", "TEMPERATURA", "HUMEDAD", "PRESION", "RADIACION", "PRECIPITACION")

datos_horarios_meteo$VEL_VIENTO <- as.numeric(datos_horarios_meteo$VEL_VIENTO)
datos_horarios_meteo$DIR_VIENTO <- as.numeric(datos_horarios_meteo$DIR_VIENTO)
datos_horarios_meteo$TEMPERATURA <- as.numeric(datos_horarios_meteo$TEMPERATURA)
datos_horarios_meteo$HUMEDAD <- as.numeric(datos_horarios_meteo$HUMEDAD)
datos_horarios_meteo$PRESION <- as.numeric(datos_horarios_meteo$PRESION)
datos_horarios_meteo$RADIACION <- as.numeric(datos_horarios_meteo$RADIACION)
datos_horarios_meteo$PRECIPITACION <- as.numeric(datos_horarios_meteo$PRECIPITACION)

datos_horarios_meteo$ANO <- as.factor(datos_horarios_meteo$ANO)
datos_horarios_meteo$MES <- as.factor(datos_horarios_meteo$MES)
datos_horarios_meteo$ESTACION <- as.factor(datos_horarios_meteo$ESTACION)

summary(datos_horarios_meteo)

```

```{r message= FALSE, warning=FALSE}

head(datos_horarios_meteo)

```

```{r message= FALSE, warning=FALSE}

ggplot(datos_horarios_meteo, aes(x = MES, y = VEL_VIENTO)) +
  geom_boxplot(width = 0.4, color="black", fill="blue", alpha=0.7) +
  scale_y_continuous(limits = quantile(datos_horarios_meteo$VEL_VIENTO, c(0.1, 0.9), na.rm = TRUE)) +
  stat_summary(fun = median, geom = 'line', aes(group = 'VEL_VIENTO'), color = 'black') +
  ggtitle("  Velocidad el viento") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(x = "Mes", y = bquote(μg / m^3))

```

```{r message= FALSE, warning=FALSE}

ggplot(datos_horarios_meteo, aes(x = HORA, y = VEL_VIENTO)) +
  geom_boxplot(width = 0.4, color="black", fill="blue", alpha=0.7) +
  scale_y_continuous(limits = quantile(datos_horarios_meteo$VEL_VIENTO, c(0.1, 0.9), na.rm = TRUE)) +
  stat_summary(fun = median, geom = 'line', aes(group = 'VEL_VIENTO'), color = 'black') +
  ggtitle("  VEL_VIENTO") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(x = "Hora", y = bquote(μg / m^3))

```



