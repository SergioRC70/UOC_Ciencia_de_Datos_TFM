---
title: 'Análisis calidad del aire Madrid'
author: "Autor: Sergio Romero Córdoba"
date: "Marzo 2022"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Estudio de la calidad del aire en Madrid

```{r message= FALSE, warning=FALSE}

library(dplyr)
library(tidyr)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(plyr)
library(cowplot)
library(ggpubr)
library(tseries)

```

## Carga y limpieza del juego de datos horarios de calidad del aire

Cargamos en primer lugar el conjunto de datos horarios de calidad del aire y vemos su estructura.

```{r message= FALSE, warning=FALSE}

mydir = "Datos horarios"
myFiles = list.files(path = mydir, pattern = "*.csv", full.names = TRUE, recursive = TRUE)
datos_horarios_aire <- myFiles %>% map_df(~read_csv2(.x, show_col_types = FALSE) %>% mutate(MES = as.character(MES))) 
str(datos_horarios_aire)

```

Cada registro está estructurado de la siguiente forma:

PROVINCIA, MUNICIPIO, ESTACION, MAGNITUD, PUNTO_MUESTREO, ANO, MES, H01, V01, H02, V02... H24, V24

Donde H01 corresponde al dato de la primera hora, H02 la segunda y así sucesivamente.

Vamos a ver ahora los distintos valores para la columna MAGNITUD. Estos valores nos identifican los distintos datos que se miden en cada una de las estaciones:

```{r message= FALSE, warning=FALSE}

distinct(datos_horarios_aire, MAGNITUD)

```

En la definición del conjunto de datos encontramos los tipos de contaminantes que corresponden a cada uno de estos códigos:

```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

cat("
| ID    | Nombre contaminante                 | Código  |
|-------|:------------------------------------|:--------|
| 01    | Dióxido de Azufre                   | SO2     |
| 06    | Monóxido de Carbono                 | CO      |
| 07    | Monóxido de Nitrógeno               | NO      |
| 08    | Dióxido de Nitrógeno                | NO2     |
| 09    | Partículas < 2.5 µm                 | PM2.5   |
| 10    | Partículas < 10 µm                  | PM10    |
| 12    | Óxidos de Nitrógeno                 | NOx     |
| 14    | Ozono                               | O3      |
| 20    | Tolueno                             | TOL     |
| 30    | Benceno                             | BEN     |
| 35    | Etilbenceno                         | EBE     |
| 37    | Metaxileno                          | MXY     |
| 38    | Paraxileno                          | PXY     |
| 39    | Ortoxileno                          | OXY     |
| 42    | Hidrocarburos totales (hexano)      | TCH     |
| 43    | Metano                              | CH4     |
| 44    | Hidrocarburos no metánicos (hexano) | NMHC    |
")

```

Se puede encontrar más detalle de cada uno de los tipos de contaminantes en el portal web de calidad del aire del ayuntamiento de Madrid (http://www.mambiente.madrid.es/opencms/opencms/calaire/ContAtmosferica/Contaminantes/Tipos.html).

Las columnas Vx identifican los valores que han sido validados. Vamos a limpiar en primer lugar los datos no validados.

```{r message= FALSE, warning=FALSE}

datos_horarios_aire$H01 <- ifelse(datos_horarios_aire$V01 == "N", NA, datos_horarios_aire$H01)
datos_horarios_aire$H02 <- ifelse(datos_horarios_aire$V02 == "N", NA, datos_horarios_aire$H02)
datos_horarios_aire$H03 <- ifelse(datos_horarios_aire$V03 == "N", NA, datos_horarios_aire$H03)
datos_horarios_aire$H04 <- ifelse(datos_horarios_aire$V04 == "N", NA, datos_horarios_aire$H04)
datos_horarios_aire$H05 <- ifelse(datos_horarios_aire$V05 == "N", NA, datos_horarios_aire$H05)
datos_horarios_aire$H06 <- ifelse(datos_horarios_aire$V06 == "N", NA, datos_horarios_aire$H06)
datos_horarios_aire$H07 <- ifelse(datos_horarios_aire$V07 == "N", NA, datos_horarios_aire$H07)
datos_horarios_aire$H08 <- ifelse(datos_horarios_aire$V08 == "N", NA, datos_horarios_aire$H08)
datos_horarios_aire$H09 <- ifelse(datos_horarios_aire$V09 == "N", NA, datos_horarios_aire$H09)
datos_horarios_aire$H10 <- ifelse(datos_horarios_aire$V10 == "N", NA, datos_horarios_aire$H10)
datos_horarios_aire$H11 <- ifelse(datos_horarios_aire$V11 == "N", NA, datos_horarios_aire$H11)
datos_horarios_aire$H12 <- ifelse(datos_horarios_aire$V12 == "N", NA, datos_horarios_aire$H12)
datos_horarios_aire$H13 <- ifelse(datos_horarios_aire$V13 == "N", NA, datos_horarios_aire$H13)
datos_horarios_aire$H14 <- ifelse(datos_horarios_aire$V14 == "N", NA, datos_horarios_aire$H14)
datos_horarios_aire$H15 <- ifelse(datos_horarios_aire$V15 == "N", NA, datos_horarios_aire$H15)
datos_horarios_aire$H16 <- ifelse(datos_horarios_aire$V16 == "N", NA, datos_horarios_aire$H16)
datos_horarios_aire$H17 <- ifelse(datos_horarios_aire$V17 == "N", NA, datos_horarios_aire$H17)
datos_horarios_aire$H18 <- ifelse(datos_horarios_aire$V18 == "N", NA, datos_horarios_aire$H18)
datos_horarios_aire$H19 <- ifelse(datos_horarios_aire$V19 == "N", NA, datos_horarios_aire$H19)
datos_horarios_aire$H20 <- ifelse(datos_horarios_aire$V20 == "N", NA, datos_horarios_aire$H20)
datos_horarios_aire$H21 <- ifelse(datos_horarios_aire$V21 == "N", NA, datos_horarios_aire$H21)
datos_horarios_aire$H22 <- ifelse(datos_horarios_aire$V22 == "N", NA, datos_horarios_aire$H22)
datos_horarios_aire$H23 <- ifelse(datos_horarios_aire$V23 == "N", NA, datos_horarios_aire$H23)
datos_horarios_aire$H24 <- ifelse(datos_horarios_aire$V24 == "N", NA, datos_horarios_aire$H24)

```

Vamos a eliminar algunas de las columnas que no nos aportan información:

- Las columnas Vx

- Las columnas PROVINCIA, MUNICIPIO y PUNTO_MUESTREO no aportan información ya que se trata para todos los casos de estaciones de Madrid y el punto de muestreo es una combinación de los valores de provincia, municipio y estación.

```{r message= FALSE, warning=FALSE}

datos_horarios_aire <- datos_horarios_aire[, -grep("^V", colnames(datos_horarios_aire))]
datos_horarios_aire <- subset(datos_horarios_aire, select = -c(PROVINCIA, MUNICIPIO, PUNTO_MUESTREO))

```

A continuación, reorganizamos nuestro dataframe de manera que las distintas magnitudes se muestren como columnas, mientras que las horas pasaran a ser filas (cada fila corresponderá a una hora).

```{r message= FALSE, warning=FALSE}

datos_horarios_aire <- datos_horarios_aire %>%
  gather("HORA", "VALOR", H01:H24) %>%
  spread(key = MAGNITUD, value = "VALOR")

```

Vamos a quedarnos con un pequeño grupo de contaminantes. Este grupo se ha escogido en base al índice de calidad del aire (ICA) creado por la Agencia Europea de Medio Ambiente (AEMA). El ICA se basa en cinco contaminantes clave que son perjudiciales para la salud de las personas y el medioambiente: partículas en suspensión (PM2,5 y PM10), ozono troposférico (O3), dióxido de nitrógeno (NO2) y dióxido de azufre (SO2). Los detalles sobre el ICA se pueden encontrar en la página web de la AEMA (https://www.eea.europa.eu/es/highlights/indice-europeo-de-calidad-del).

```{r message= FALSE, warning=FALSE}

datos_horarios_aire <- datos_horarios_aire[,c(1:6, 9:11, 13)]

```

Por último, cambiamos el nombre de las columnas para poner un nombre significativo, convertimos las columnas con los valores de los contaminantes a tipo numeric y añadimos un campo con la fecha que utilizaremos en QGIS.

```{r message= FALSE, warning=FALSE}

colnames(datos_horarios_aire) <- c("ESTACION", "ANO", "MES", "DIA", "HORA", "SO2", "NO2", "PM25", "PM10", "O3")

datos_horarios_aire$SO2 <- as.numeric(datos_horarios_aire$SO2)
datos_horarios_aire$NO2 <- as.numeric(datos_horarios_aire$NO2)
datos_horarios_aire$PM25 <- as.numeric(datos_horarios_aire$PM25)
datos_horarios_aire$PM10 <- as.numeric(datos_horarios_aire$PM10)
datos_horarios_aire$O3 <- as.numeric(datos_horarios_aire$O3)

datos_horarios_aire$FECHA <- make_datetime(as.integer(datos_horarios_aire$ANO), as.integer(datos_horarios_aire$MES), as.integer(datos_horarios_aire$DIA), as.integer(substring(datos_horarios_aire$HORA, 2)))


```

Mostramos información del dataset resultante.

```{r message= FALSE, warning=FALSE}

summary(datos_horarios_aire)

head(datos_horarios_aire)

```

## Carga de juego de datos con información de estaciones

Cargamos el conjunto de datos con informaciones de las estaciones de control y vemos su estructura.

```{r message= FALSE, warning=FALSE}

datos_estaciones_aire <- read_delim("Estaciones/informacion_estaciones_red_calidad_aire.csv", delim = ";", show_col_types = FALSE)
str(datos_estaciones_aire)

```

Únicamente vamos a utilizar los datos de código de estación, nombre de la estación y tipo de estación.

```{r message= FALSE, warning=FALSE}

datos_estaciones_aire <- datos_estaciones_aire[,c("CODIGO_CORTO", "ESTACION", "NOM_TIPO")]

```

Añadimos esta información al conjunto de datos horarios de calidad del aire.

```{r message= FALSE, warning=FALSE}

datos_horarios_aire <- merge(x = datos_horarios_aire, y = datos_estaciones_aire, by.x = "ESTACION", by.y = "CODIGO_CORTO", all = TRUE)
colnames(datos_horarios_aire)[12] <- "NOM_ESTACION"

```

Vamos a guardar nuestro dataset en un fichero csv que utilizaremos para cargar estos datos en una base de datos PostGIS.

```{r message= FALSE, warning=FALSE}

write_csv(datos_horarios_aire, path = "datos_horarios_aire.csv", append = FALSE, col_names = TRUE, na = '')

```

## Análisis de datos de calidad del aire

### Outliers

Buscamos en primer lugar outliers entre los datos

```{r message= FALSE, warning=FALSE}

ggplot(datos_horarios_aire, aes(y = SO2)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  SO2") +
  theme_bw() +
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_horarios_aire, aes(y = NO2)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  NO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_horarios_aire, aes(y = PM10)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  PM10") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_horarios_aire, aes(y = PM25)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  PM25") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

ggplot(datos_horarios_aire, aes(y = O3)) +
  geom_boxplot(width = 0.4) +
  ggtitle("  O3") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 40, b = -20))) + 
  labs(y = bquote(μg / m^3))

```

En todos los contaminantes se encuentran valores muy superiores a los valores medios. Se han comprobado los valores más extremos y en todos los casos aparecen como validados, por lo tanto, se darán como valores correctos.

A continuación se van a generar una serie de gráficas para el análisis de los distintos contaminantes así como el análisis de la creación de Madrid Central y el periodo de confinamiento de 2020. Las reflexiones sobre este análisis se mostraran en la memoria del TFM

```{r message= FALSE, warning=FALSE}

# Para el resto de gráficas vamos asociar un color a cada uno de los contaminantes.
colores <- c("#fd7f6f", "#7eb0d5", "#b2e061", "#bd7ebe", "#ffb55a")
names(colores) <- c("SO2", "NO2", "PM10", "PM25", "O3")

```

```{r message= FALSE, warning=FALSE}

df_anual <- ddply(datos_horarios_aire, c("ANO"), summarize, SO2.mean = mean(SO2, na.rm = T), NO2.mean = mean(NO2, na.rm = T), PM10.mean = mean(PM10, na.rm = T), PM25.mean = mean(PM25, na.rm = T), O3.mean = mean(O3, na.rm = T))

```

### Análisis SO2

```{r message= FALSE, warning=FALSE}

p1 <- ggplot(df_anual, aes(x = ANO, y = SO2.mean)) +
  geom_line(size = 0.5, color = colores["SO2"]) +
  geom_smooth(method = "lm", se = FALSE, size = 0.5) +
  ggtitle("Evolución anual") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

datos_horarios_aire_SO2 <- datos_horarios_aire[!is.na(datos_horarios_aire$SO2), ]

p2 <- ggplot(datos_horarios_aire_SO2, aes(x = as.factor(ESTACION), y = SO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["SO2"], alpha = 0.7) +
  ggtitle("Estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_SO2$SO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

p3 <- ggplot(datos_horarios_aire_SO2, aes(x = as.factor(NOM_TIPO), y = SO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["SO2"], alpha = 0.7) +
  ggtitle("Tipo de estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_SO2$SO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

p4 <- ggplot(datos_horarios_aire_SO2, aes(x = as.factor(MES), y = SO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["SO2"], alpha = 0.7) +
  ggtitle("Mes") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_SO2$SO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

p5 <- ggplot(datos_horarios_aire_SO2, aes(x = as.factor(substr(HORA, 2, 3)), y = SO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["SO2"], alpha = 0.7) +
  ggtitle("Hora") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_SO2$SO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

```

```{r message= FALSE, warning=FALSE}

plot_so2 <- ggarrange(p1,
          ggarrange(p2, p3, ncol = 2),
          ggarrange(p4, p5, ncol = 2),
          nrow = 3
          ) 

save_plot("01_SO2.png", plot_so2, base_width = 8, base_height = 8)

plot_so2

```

```{r message= FALSE, warning=FALSE}

# Test de Dickey-Fuller ara los datos de los últimos 10 años
adf.test(df_diario[!is.na(df_diario$SO2.mean) & df_diario$FECHA >= "2008/01/01", ]$SO2.mean)

```

```{r message= FALSE, warning=FALSE}

#df_diario <- ddply(datos_horarios_aire, c("FECHA"), summarize, SO2.mean = mean(SO2, na.rm = T), NO2.mean = mean(NO2, na.rm = T), PM10.mean = mean(PM10, na.rm = T), PM25.mean = mean(PM25, na.rm = T), O3.mean = mean(O3, na.rm = T))

# Decomposición de la serie temporal
firstHour <- 24*(as.Date("2001-1-1 1:00:00")-as.Date("2001-1-1 00:00:00"))
lastHour <- as.Date("2022-1-1 00:00:00")
tt <- ts(df_diario[!is.na(df_diario$SO2), ]$SO2,start=c(2001,firstHour), frequency=24*365)
SO2Decompose  <- decompose(tt)
plot(SO2Decompose)

```


### Análisis NO2

```{r message= FALSE, warning=FALSE}

p1 <- ggplot(df_anual, aes(x = ANO, y = NO2.mean)) +
  geom_line(size = 0.5, color = colores["NO2"]) +
  geom_smooth(method = "lm", se = FALSE, size = 0.5) +
  ggtitle("Evolución anual") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

datos_horarios_aire_NO2 <- datos_horarios_aire[!is.na(datos_horarios_aire$NO2), ]

p2 <- ggplot(datos_horarios_aire_NO2, aes(x = as.factor(ESTACION), y = NO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["NO2"], alpha = 0.7) +
  ggtitle("Estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_NO2$NO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p3 <- ggplot(datos_horarios_aire_NO2, aes(x = as.factor(NOM_TIPO), y = NO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["NO2"], alpha = 0.7) +
  ggtitle("Tipo de estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_NO2$NO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p4 <- ggplot(datos_horarios_aire_NO2, aes(x = as.factor(MES), y = NO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["NO2"], alpha = 0.7) +
  ggtitle("Mes") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_NO2$NO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p5 <- ggplot(datos_horarios_aire_NO2, aes(x = as.factor(substr(HORA, 2, 3)), y = NO2)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["NO2"], alpha = 0.7) +
  ggtitle("Hora") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_NO2$NO2, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

```

```{r message= FALSE, warning=FALSE}

plot_no2 <- ggarrange(p1,
          ggarrange(p2, p3, ncol = 2),
          ggarrange(p4, p5, ncol = 2),
          nrow = 3
          ) 

save_plot("01_NO2.png", plot_no2, base_width = 8, base_height = 8)

plot_no2

```

```{r message= FALSE, warning=FALSE}

# Test de Dickey-Fuller ara los datos de los últimos 10 años
adf.test(df_diario[!is.na(df_diario$NO2.mean) & df_diario$FECHA >= "2008/01/01", ]$NO2.mean)

```

### Análisis PM25

```{r message= FALSE, warning=FALSE}

p1 <- ggplot(df_anual, aes(x = ANO, y = PM25.mean)) +
  geom_line(size = 0.5, color = colores["PM25"]) +
  geom_smooth(method = "lm", se = FALSE, size = 0.5) +
  ggtitle("Evolución anual") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

datos_horarios_aire_PM25 <- datos_horarios_aire[!is.na(datos_horarios_aire$PM25), ]

p2 <- ggplot(datos_horarios_aire_PM25, aes(x = as.factor(ESTACION), y = PM25)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM25"], alpha = 0.7) +
  ggtitle("Estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM25$PM25, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p3 <- ggplot(datos_horarios_aire_PM25, aes(x = as.factor(NOM_TIPO), y = PM25)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM25"], alpha = 0.7) +
  ggtitle("Tipo de estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM25$PM25, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p4 <- ggplot(datos_horarios_aire_PM25, aes(x = as.factor(MES), y = PM25)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM25"], alpha = 0.7) +
  ggtitle("Mes") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM25$PM25, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p5 <- ggplot(datos_horarios_aire_PM25, aes(x = as.factor(substr(HORA, 2, 3)), y = PM25)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM25"], alpha = 0.7) +
  ggtitle("Hora") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM25$PM25, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

```

```{r message= FALSE, warning=FALSE}

plot_pm25 <- ggarrange(p1,
          ggarrange(p2, p3, ncol = 2),
          ggarrange(p4, p5, ncol = 2),
          nrow = 3
          ) 

save_plot("01_PM25.png", plot_pm25, base_width = 8, base_height = 8)

plot_pm25

```

```{r message= FALSE, warning=FALSE}

# Test de Dickey-Fuller ara los datos de los últimos 10 años
adf.test(df_diario[!is.na(df_diario$PM25.mean) & df_diario$FECHA >= "2008/01/01", ]$PM25.mean)

```

### Análisis PM10

```{r message= FALSE, warning=FALSE}

p1 <- ggplot(df_anual, aes(x = ANO, y = PM10.mean)) +
  geom_line(size = 0.5, color = colores["PM10"]) +
  geom_smooth(method = "lm", se = FALSE, size = 0.5) +
  ggtitle("Evolución anual") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

datos_horarios_aire_PM10 <- datos_horarios_aire[!is.na(datos_horarios_aire$PM10), ]

p2 <- ggplot(datos_horarios_aire_PM10, aes(x = as.factor(ESTACION), y = PM10)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM10"], alpha = 0.7) +
  ggtitle("Estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM10$PM10, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p3 <- ggplot(datos_horarios_aire_PM10, aes(x = as.factor(NOM_TIPO), y = PM10)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM10"], alpha = 0.7) +
  ggtitle("Tipo de estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM10$PM10, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p4 <- ggplot(datos_horarios_aire_PM10, aes(x = as.factor(MES), y = PM10)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM10"], alpha = 0.7) +
  ggtitle("Mes") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM10$PM10, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p5 <- ggplot(datos_horarios_aire_PM10, aes(x = as.factor(substr(HORA, 2, 3)), y = PM25)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["PM10"], alpha = 0.7) +
  ggtitle("Hora") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_PM10$PM10, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

```

```{r message= FALSE, warning=FALSE}

plot_pm10 <- ggarrange(p1,
          ggarrange(p2, p3, ncol = 2),
          ggarrange(p4, p5, ncol = 2),
          nrow = 3
          ) 

save_plot("01_PM10.png", plot_pm10, base_width = 8, base_height = 8)

plot_pm10

```

```{r message= FALSE, warning=FALSE}

# Test de Dickey-Fuller ara los datos de los últimos 10 años
adf.test(df_diario[!is.na(df_diario$PM10.mean) & df_diario$FECHA >= "2008/01/01", ]$PM10.mean)

```

### Análisis O3

```{r message= FALSE, warning=FALSE}

p1 <- ggplot(df_anual, aes(x = ANO, y = O3.mean)) +
  geom_line(size = 0.5, color = colores["O3"]) +
  geom_smooth(method = "lm", se = FALSE, size = 0.5) +
  ggtitle("Evolución anual") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(), y = bquote(μg / m^3))

datos_horarios_aire_O3 <- datos_horarios_aire[!is.na(datos_horarios_aire$O3), ]

p2 <- ggplot(datos_horarios_aire_O3, aes(x = as.factor(ESTACION), y = O3)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["O3"], alpha = 0.7) +
  ggtitle("Estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_O3$O3, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p3 <- ggplot(datos_horarios_aire_O3, aes(x = as.factor(NOM_TIPO), y = O3)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["O3"], alpha = 0.7) +
  ggtitle("Tipo de estación") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_O3$O3, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p4 <- ggplot(datos_horarios_aire_O3, aes(x = as.factor(MES), y = O3)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["O3"], alpha = 0.7) +
  ggtitle("Mes") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_O3$O3, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p5 <- ggplot(datos_horarios_aire_O3, aes(x = as.factor(substr(HORA, 2, 3)), y = O3)) +
  geom_boxplot(width = 0.4, color = "black", fill = colores["O3"], alpha = 0.7) +
  ggtitle("Hora") +
  scale_y_continuous(limits = quantile(datos_horarios_aire_O3$O3, c(0.1, 0.9), na.rm = TRUE)) +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold')) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

```

```{r message= FALSE, warning=FALSE}

plot_o3 <- ggarrange(p1,
          ggarrange(p2, p3, ncol = 2),
          ggarrange(p4, p5, ncol = 2),
          nrow = 3
          ) 

save_plot("01_O3.png", plot_o3, base_width = 8, base_height = 8)

plot_o3

```

```{r message= FALSE, warning=FALSE}

# Test de Dickey-Fuller ara los datos de los últimos 10 años
adf.test(df_diario[!is.na(df_diario$O3.mean) & df_diario$FECHA >= "2008/01/01", ]$O3.mean)

```

### Análisis Confinamiento

```{r message= FALSE, warning=FALSE}

df_confinamiento <- datos_horarios_aire %>% 
  filter(FECHA > '2020-01-01' & FECHA < '2020-05-25') %>% 
  ddply(c("ANO", "MES", "DIA"), summarize, SO2.mean = mean(SO2, na.rm = T), NO2.mean = mean(NO2, na.rm = T), PM10.mean = mean(PM10, na.rm = T), PM25.mean = mean(PM25, na.rm = T), O3.mean = mean(O3, na.rm = T))

df_confinamiento$FECHA <- ISOdate(as.integer(df_confinamiento$ANO), as.integer(df_confinamiento$MES), as.integer(df_confinamiento$DIA))

datos_horarios_aire_antes_lockdown <- df_confinamiento %>% 
  filter(FECHA <= '2020-03-14')
datos_horarios_aire_lockdown <- df_confinamiento %>% 
  filter(FECHA > '2020-03-14')

mean_so2_antes_lockdown <- mean(datos_horarios_aire_antes_lockdown$SO2, na.rm=TRUE)
mean_so2_lockdown <- mean(datos_horarios_aire_lockdown$SO2.mean, na.rm=TRUE)
mean_no2_antes_lockdown <- mean(datos_horarios_aire_antes_lockdown$NO2, na.rm=TRUE)
mean_no2_lockdown <- mean(datos_horarios_aire_lockdown$NO2.mean, na.rm=TRUE)
mean_pm25_antes_lockdown <- mean(datos_horarios_aire_antes_lockdown$PM25, na.rm=TRUE)
mean_pm25_lockdown <- mean(datos_horarios_aire_lockdown$PM25.mean, na.rm=TRUE)
mean_pm10_antes_lockdown <- mean(datos_horarios_aire_antes_lockdown$PM10, na.rm=TRUE)
mean_pm10_lockdown <- mean(datos_horarios_aire_lockdown$PM10.mean, na.rm=TRUE)
mean_o3_antes_lockdown <- mean(datos_horarios_aire_antes_lockdown$O3, na.rm=TRUE)
mean_o3_lockdown <- mean(datos_horarios_aire_lockdown$O3.mean, na.rm=TRUE)

```

```{r message= FALSE, warning=FALSE}

p1c <- ggplot(df_confinamiento, aes(x = FECHA, y = SO2.mean, group = 1)) +
  geom_line(color = colores["SO2"]) +
  geom_segment(aes(x = ISOdate("2020", "01", "01"), xend = ISOdate("2020", "03", "14"), y = mean_so2_antes_lockdown, yend = mean_so2_antes_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "02", "01"), mean_so2_antes_lockdown, label = 'valor medio antes de confinamiento', vjust = -1, fontface = 'plain', family = 'arial'), size = 3) +
  geom_segment(aes(x = ISOdate("2020", "03", "14"), xend = ISOdate("2020", "05", "25"), y = mean_so2_lockdown, yend = mean_so2_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "04", "15"), mean_so2_lockdown, label = 'valor medio durante el confinamiento', vjust = -1, fontface = 'plain', family = 'arial'), size = 3) +
  geom_vline(xintercept = ISOdate("2020", "03", "14"), linetype = 'solid', colour='red') +
  ggtitle("  SO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p2c <- ggplot(df_confinamiento, aes(x = FECHA, y = NO2.mean, group = 1)) +
  geom_line(color = colores["NO2"]) +
  geom_segment(aes(x = ISOdate("2020", "01", "01"), xend = ISOdate("2020", "03", "14"), y = mean_no2_antes_lockdown, yend = mean_no2_antes_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "02", "01"), mean_no2_antes_lockdown, label = 'valor medio antes de confinamiento', vjust = -1, fontface = 'plain', family = 'arial'), size = 3) +
  geom_segment(aes(x = ISOdate("2020", "03", "14"), xend = ISOdate("2020", "05", "25"), y = mean_no2_lockdown, yend = mean_no2_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "04", "15"), mean_no2_lockdown, label = 'valor medio durante el confinamiento', vjust = -2, fontface = 'plain', family = 'arial'), size = 3) +
  geom_vline(xintercept = ISOdate("2020", "03", "14"), linetype = 'solid', colour='red') +
  ggtitle("  NO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p3c <- ggplot(df_confinamiento, aes(x = FECHA, y = PM25.mean, group = 1)) +
  geom_line(color = colores["PM25"]) +
  geom_segment(aes(x = ISOdate("2020", "01", "01"), xend = ISOdate("2020", "03", "14"), y = mean_pm25_antes_lockdown, yend = mean_pm25_antes_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "02", "01"), mean_pm25_antes_lockdown, label = 'valor medio antes de confinamiento', vjust = -1, fontface = 'plain', family = 'arial'), size = 3) +
  geom_segment(aes(x = ISOdate("2020", "03", "14"), xend = ISOdate("2020", "05", "25"), y = mean_pm25_lockdown, yend = mean_pm25_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "04", "15"), mean_pm25_lockdown, label = 'valor medio durante el confinamiento', vjust = -2, fontface = 'plain', family = 'arial'), size = 3) +
  geom_vline(xintercept = ISOdate("2020", "03", "14"), linetype = 'solid', colour='red') +
  ggtitle("  PM25") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p4c <- ggplot(df_confinamiento, aes(x = FECHA, y = PM10.mean, group = 1)) +
  geom_line(color = colores["PM10"]) +  
  geom_segment(aes(x = ISOdate("2020", "01", "01"), xend = ISOdate("2020", "03", "14"), y = mean_pm10_antes_lockdown, yend = mean_pm10_antes_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "02", "01"), mean_pm10_antes_lockdown, label = 'valor medio antes de confinamiento', vjust = -1, fontface = 'plain', family = 'arial'), size = 3) +
  geom_segment(aes(x = ISOdate("2020", "03", "14"), xend = ISOdate("2020", "05", "25"), y = mean_pm10_lockdown, yend = mean_pm10_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "04", "15"), mean_pm10_lockdown, label = 'valor medio durante el confinamiento', vjust = -2, fontface = 'plain', family = 'arial'), size = 3) +
  geom_vline(xintercept = ISOdate("2020", "03", "14"), linetype = 'solid', colour='red') +
  ggtitle("  PM10") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p5c <- ggplot(df_confinamiento, aes(x = FECHA, y = O3.mean, group = 1)) +
  geom_line(color = colores["O3"]) +
  geom_segment(aes(x = ISOdate("2020", "01", "01"), xend = ISOdate("2020", "03", "14"), y = mean_o3_antes_lockdown, yend = mean_o3_antes_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "02", "01"), mean_o3_antes_lockdown, label = 'valor medio antes de confinamiento', vjust = -1, fontface = 'plain', family = 'arial'), size = 3) +
  geom_segment(aes(x = ISOdate("2020", "03", "14"), xend = ISOdate("2020", "05", "25"), y = mean_o3_lockdown, yend = mean_o3_lockdown), linetype = 'dashed') +
  geom_text(aes(ISOdate("2020", "04", "15"), mean_o3_lockdown, label = 'valor medio durante el confinamiento', vjust = 3, fontface = 'plain', family = 'arial'), size = 3) +
  geom_vline(xintercept = ISOdate("2020", "03", "14"), linetype = 'solid', colour='red') +
  ggtitle("  O3") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

plot_confinamiento <- plot_grid(p1c, p2c, p3c, p4c, p5c, nrow = 5, rel_heights = c(1, 1, 1, 1, 1.2))
save_plot("01_confinamiento.png", plot_confinamiento, base_width = 8, base_height = 8)
plot_confinamiento

```

Incremento/decremento porcentual

```{r message= FALSE, warning=FALSE}

(mean_so2_lockdown / mean_so2_antes_lockdown - 1 ) * 100
(mean_no2_lockdown / mean_no2_antes_lockdown - 1 ) * 100
(mean_pm25_lockdown / mean_pm25_antes_lockdown - 1 ) * 100
(mean_pm10_lockdown / mean_pm10_antes_lockdown - 1 ) * 100
(mean_o3_lockdown / mean_o3_antes_lockdown - 1 ) * 100

```

```{r message= FALSE, warning=FALSE}

df_confinamiento_lockdown_anio_anterior <- datos_horarios_aire %>% 
  filter(FECHA > '2019-03-14' & FECHA < '2019-05-25') %>% 
  ddply(c("ANO", "MES", "DIA"), summarize, SO2.mean = mean(SO2, na.rm = T), NO2.mean = mean(NO2, na.rm = T), PM10.mean = mean(PM10, na.rm = T), PM25.mean = mean(PM25, na.rm = T), O3.mean = mean(O3, na.rm = T))

colnames(df_confinamiento_lockdown_anio_anterior) <- c("ANO", "MES", "DIA", "SO2.ant", "NO2.ant", "PM10.ant", "PM25.ant", "O3.ant")

df_confinamiento_lockdown_anio_anterior <- merge(x = df_confinamiento_lockdown_anio_anterior, y = datos_horarios_aire_lockdown, by = c("MES", "DIA"), all = TRUE)

```

```{r message= FALSE, warning=FALSE}

p1c <- ggplot(df_confinamiento_lockdown_anio_anterior, aes(x = FECHA)) +
  geom_line(aes(y = SO2.mean), color = colores["SO2"]) +
  geom_line(aes(y = SO2.ant), color = colores["NO2"]) +
  ggtitle("  SO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p2c <- ggplot(df_confinamiento_lockdown_anio_anterior, aes(x = FECHA)) +
  geom_line(aes(y = NO2.mean), color = colores["SO2"]) +
  geom_line(aes(y = NO2.ant), color = colores["NO2"]) +
  ggtitle("  NO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p3c <- ggplot(df_confinamiento_lockdown_anio_anterior, aes(x = FECHA)) +
  geom_line(aes(y = PM10.mean), color = colores["SO2"]) +
  geom_line(aes(y = PM10.ant), color = colores["NO2"]) +
  ggtitle("  PM10") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p4c <- ggplot(df_confinamiento_lockdown_anio_anterior, aes(x = FECHA)) +
  geom_line(aes(y = PM25.mean), color = colores["SO2"]) +
  geom_line(aes(y = PM25.ant), color = colores["NO2"]) +
  ggtitle("  PM25") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), axis.text.x=element_blank(), axis.title.x=element_blank(), axis.ticks.x = element_blank(), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

p5c <- ggplot(df_confinamiento_lockdown_anio_anterior, aes(x = FECHA)) +
  geom_line(aes(y = O3.mean), color = colores["SO2"]) +
  geom_line(aes(y = O3.ant), color = colores["NO2"]) +
  ggtitle("  O3") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), panel.grid.major.y = element_blank()) + 
  labs(y = bquote(μg / m^3))

plot_confinamiento_ant <- plot_grid(p1c, p2c, p3c, p4c, p5c, nrow = 5, rel_heights = c(1, 1, 1, 1, 1.2))
save_plot("01_confinamiento_ant.png", plot_confinamiento_ant, base_width = 8, base_height = 8)
plot_confinamiento_ant

```



### Análisis Madrid ZBEDEP

```{r message= FALSE, warning=FALSE}

# Cogemos un periodo de un año desde la entrada en vigor de Madrid central y el mismo periodo del año anterior para su comparación. Además, cogemos únicamente las estaciones que están dentro de Madrid Central.
df_zbedep <- datos_horarios_aire %>% 
  filter(FECHA >= '2017-11-30' & FECHA <= '2019-11-30' & ESTACION == 35) %>% 
  ddply(c("ANO", "MES", "DIA"), summarize, SO2.mean = mean(SO2, na.rm = T), NO2.mean = mean(NO2, na.rm = T), PM10.mean = mean(PM10, na.rm = T), PM25.mean = mean(PM25, na.rm = T), O3.mean = mean(O3, na.rm = T))

# Añadimos la columna con la fecha
df_zbedep$FECHA <- ISOdate(as.integer(df_zbedep$ANO), as.integer(df_zbedep$MES), as.integer(df_zbedep$DIA))

# Añadimos una columna tipo para mostrar boxplot de comparación
df_zbedep <- df_zbedep %>% 
  mutate(TIPO = case_when(
    FECHA < '2018-11-30' ~ "NO ZBEDEP",
    TRUE ~ "ZBEDEP"))

```


```{r message= FALSE, warning=FALSE}

p1z  <- ggplot(df_zbedep, aes(x = as.factor(TIPO), y = NO2.mean, fill = TIPO)) +
  geom_boxplot(width = 0.4, color = "black", alpha = 0.7) +
  scale_fill_manual(values=c("#999999", "#E69F00")) +
  scale_y_continuous(limits = quantile(df_zbedep$NO2.mean, c(0.1, 0.9), na.rm = TRUE)) +
  ggtitle("  NO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), legend.position = "none") + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p2z  <- ggplot(df_zbedep, aes(x = as.factor(TIPO), y = SO2.mean, fill = TIPO)) +
  geom_boxplot(width = 0.4, color = "black", alpha = 0.7) +
  scale_fill_manual(values=c("#999999", "#E69F00")) +
  scale_y_continuous(limits = quantile(df_zbedep$SO2.mean, c(0.1, 0.9), na.rm = TRUE)) +
  ggtitle("  SO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), legend.position = "none") + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p3z  <- ggplot(df_zbedep, aes(x = as.factor(TIPO), y = O3.mean, fill = TIPO)) +
  geom_boxplot(width = 0.4, color = "black", alpha = 0.7) +
  scale_fill_manual(values=c("#999999", "#E69F00")) +
  scale_y_continuous(limits = quantile(df_zbedep$O3, c(0.1, 0.9), na.rm = TRUE)) +
  ggtitle("  O3") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98)) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

plot_zbedep <- plot_grid(p1z, p2z, p3z, nrow = 1, rel_widths = c(0.75, 0.75, 1))
save_plot("01_zbedep.png", plot_zbedep, base_width = 15, base_height = 3)
plot_zbedep

```

```{r message= FALSE, warning=FALSE}

# Cogemos un periodo de un año desde la entrada en vigor de Madrid central y el mismo periodo del año anterior para su comparación. Además, cogemos únicamente las estaciones que están dentro de Madrid Central.
df_zbedep_todas_estaciones <- datos_horarios_aire %>% 
  filter(FECHA >= '2017-11-30' & FECHA <= '2019-11-30') %>% 
  ddply(c("ANO", "MES", "DIA"), summarize, SO2.mean = mean(SO2, na.rm = T), NO2.mean = mean(NO2, na.rm = T), PM10.mean = mean(PM10, na.rm = T), PM25.mean = mean(PM25, na.rm = T), O3.mean = mean(O3, na.rm = T))

# Añadimos la columna con la fecha
df_zbedep_todas_estaciones$FECHA <- ISOdate(as.integer(df_zbedep_todas_estaciones$ANO), as.integer(df_zbedep_todas_estaciones$MES), as.integer(df_zbedep_todas_estaciones$DIA))

# Añadimos una columna tipo para mostrar boxplot de comparación
df_zbedep_todas_estaciones <- df_zbedep_todas_estaciones %>% 
  mutate(TIPO = case_when(
    FECHA < '2018-11-30' ~ "NO ZBEDEP",
    TRUE ~ "ZBEDEP"))

```

```{r message= FALSE, warning=FALSE}

p1z  <- ggplot(df_zbedep_todas_estaciones, aes(x = as.factor(TIPO), y = NO2.mean, fill = TIPO)) +
  geom_boxplot(width = 0.4, color = "black", alpha = 0.7) +
  scale_fill_manual(values=c("#999999", "#E69F00")) +
  scale_y_continuous(limits = quantile(df_zbedep_todas_estaciones$NO2.mean, c(0.1, 0.9), na.rm = TRUE)) +
  ggtitle("  NO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), legend.position = "none") + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p2z  <- ggplot(df_zbedep_todas_estaciones, aes(x = as.factor(TIPO), y = SO2.mean, fill = TIPO)) +
  geom_boxplot(width = 0.4, color = "black", alpha = 0.7) +
  scale_fill_manual(values=c("#999999", "#E69F00")) +
  scale_y_continuous(limits = quantile(df_zbedep_todas_estaciones$SO2.mean, c(0.1, 0.9), na.rm = TRUE)) +
  ggtitle("  SO2") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98), legend.position = "none") + 
  labs(x = element_blank(),y = bquote(μg / m^3))

p3z  <- ggplot(df_zbedep_todas_estaciones, aes(x = as.factor(TIPO), y = O3.mean, fill = TIPO)) +
  geom_boxplot(width = 0.4, color = "black", alpha = 0.7) +
  scale_fill_manual(values=c("#999999", "#E69F00")) +
  scale_y_continuous(limits = quantile(df_zbedep_todas_estaciones$O3, c(0.1, 0.9), na.rm = TRUE)) +
  ggtitle("  O3") +
  theme_bw() + 
  theme(axis.text = element_text(size = 8), axis.title =  element_text(size = 9), plot.title = element_text(face = 'bold', margin = margin(t = 10, b = -20), hjust = 0.98)) + 
  labs(x = element_blank(),y = bquote(μg / m^3))

plot_zbedep <- plot_grid(p1z, p2z, p3z, nrow = 1, rel_widths = c(0.75, 0.75, 1))
save_plot("01_zbedep_todas.png", plot_zbedep, base_width = 15, base_height = 3)
plot_zbedep

```

```{r message= FALSE, warning=FALSE}

df_zbedep_antes <- df_zbedep %>% 
  filter(TIPO == "NO ZBEDEP")
df_zbedep_despues <- df_zbedep %>% 
  filter(TIPO == "ZBEDEP")
df_zbedep_todas_antes <- df_zbedep_todas_estaciones %>% 
  filter(TIPO == "NO ZBEDEP")
df_zbedep_todas_despues <- df_zbedep_todas_estaciones %>% 
  filter(TIPO == "ZBEDEP")

(mean(df_zbedep_antes$NO2.mean, na.rm = TRUE) / mean(df_zbedep_despues$NO2.mean, na.rm = TRUE) - 1) * 100
(mean(df_zbedep_todas_antes$NO2.mean, na.rm = TRUE) / mean(df_zbedep_todas_despues$NO2.mean, na.rm = TRUE) - 1) * 100
(mean(df_zbedep_antes$SO2.mean, na.rm = TRUE) / mean(df_zbedep_despues$SO2.mean, na.rm = TRUE) - 1) * 100
(mean(df_zbedep_todas_antes$SO2.mean, na.rm = TRUE) / mean(df_zbedep_todas_despues$SO2.mean, na.rm = TRUE) - 1) * 100
(mean(df_zbedep_antes$O3.mean, na.rm = TRUE) / mean(df_zbedep_despues$O3.mean, na.rm = TRUE) - 1) * 100
(mean(df_zbedep_todas_antes$O3.mean, na.rm = TRUE) / mean(df_zbedep_todas_despues$O3.mean, na.rm = TRUE) - 1) * 100

```

